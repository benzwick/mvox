# Build and deploy documentation to GitHub Pages.
# Called by C/C++ CI workflow after successful build on main.
#
# This workflow downloads example artifacts (NRRD inputs + VTK meshes),
# captures screenshots using 3D Slicer, builds Sphinx docs, and
# deploys to GitHub Pages.

name: Documentation

on:
  workflow_call:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  SLICER_VERSION: "5.10.0"
  SLICER_DOWNLOAD_URL: "https://download.slicer.org/bitstream/6911b598ac7b1c95e7934427"
  DISPLAY: ":99"

jobs:
  docs:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    concurrency:
      group: "pages"
      cancel-in-progress: false

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - uses: actions/checkout@v4

    - name: Download example artifacts
      uses: actions/download-artifact@v4
      with:
        name: examples-ubuntu-latest
        path: examples/

    - name: Set up virtual display
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xvfb \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-render-util0 \
          libxcb-shape0 \
          libxcb-xfixes0 \
          libxkbcommon-x11-0 \
          libgl1-mesa-dri \
          libegl1 \
          libxkbcommon0 \
          libdbus-1-3 \
          libfontconfig1 \
          libfreetype6 \
          libnss3 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libxtst6 \
          libasound2t64 \
          libpulse-mainloop-glib0 \
          libpulse0 \
          libglib2.0-0 \
          libopengl0 \
          libglx0 \
          libgl1 \
          libglu1-mesa \
          libsm6 \
          libice6
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 3

    - name: Cache Slicer
      id: cache-slicer
      uses: actions/cache@v4
      with:
        path: ~/Slicer
        key: slicer-${{ env.SLICER_VERSION }}-linux

    - name: Download Slicer
      if: steps.cache-slicer.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/Slicer
        curl -L -o slicer.tar.gz "$SLICER_DOWNLOAD_URL"
        tar -xzf slicer.tar.gz -C ~/Slicer --strip-components=1
        rm slicer.tar.gz

    - name: Capture screenshots
      run: ~/Slicer/Slicer --python-script scripts/capture_screenshots.py --exit

    - name: Install Sphinx
      run: pip install -r docs/requirements.txt

    - name: Build documentation
      run: sphinx-build -b html docs/source docs/_build/html

    - name: Configure Pages
      uses: actions/configure-pages@v5

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/_build/html

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
