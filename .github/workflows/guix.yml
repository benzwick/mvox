name: Guix

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - uses: actions/checkout@v4

    - name: Guix cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/guix
        key: guix-${{ hashFiles('guix/mvox/packages/*.scm') }}-week-${{ github.run_number }}
        restore-keys: guix-

    - name: Install Guix
      run: |
        # Download and extract Guix binary
        wget -qO guix-binary.tar.xz "https://ci.guix.gnu.org/search/latest/archive?query=spec:tarball+status:success+system:x86_64-linux+guix-binary.tar.xz"
        sudo tar xf guix-binary.tar.xz -C / --no-overwrite-dir

        # Create build users
        sudo groupadd --system guixbuild
        for i in $(seq -w 1 10); do
          sudo useradd -g guixbuild -G guixbuild -d /var/empty \
            -s "$(which nologin)" -c "Guix build user $i" \
            --system "guixbuilder${i}"
        done

        # Authorize substitutes
        for f in /var/guix/profiles/per-user/root/current-guix/share/guix/*.pub; do
          sudo /var/guix/profiles/per-user/root/current-guix/bin/guix archive --authorize < "$f"
        done

        # Start daemon directly (bypass systemd)
        sudo /var/guix/profiles/per-user/root/current-guix/bin/guix-daemon \
          --build-users-group=guixbuild --disable-chroot &

        # Add guix to PATH
        export GUIX_PATH=/var/guix/profiles/per-user/root/current-guix
        echo "$GUIX_PATH/bin" >> $GITHUB_PATH
        echo "LANG=en_US.utf8" >> $GITHUB_ENV

    - name: Update Guix
      run: sudo -i /var/guix/profiles/per-user/root/current-guix/bin/guix pull

    - name: Lint packages
      continue-on-error: true
      run: guix lint -L guix mfem mvox

    - name: Build MFEM
      run: guix build -L guix mfem

    - name: Build mvox
      run: guix build -L guix mvox

    - name: Smoke test (from store)
      run: $(guix build -L guix mvox)/bin/mvox --help

    - name: Install mvox
      run: guix install -L guix mvox

    - name: Smoke test (installed)
      run: mvox --help

    - name: Test boxmesh
      working-directory: examples
      run: bash boxmesh.sh

    - name: Test brain-tensors
      working-directory: examples
      run: bash brain-tensors.sh
